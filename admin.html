<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bobby Black — Admin CSM</title>
  <style>
    body { margin:0; background:#050505; color:#f1f1f1; font-family:Inter,system-ui,sans-serif; }
    .wrap { max-width:1300px; margin:0 auto; padding:20px; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    input,select,button,textarea { background:#101010; color:#fff; border:1px solid #463a18; border-radius:10px; padding:10px; }
    button { cursor:pointer; }
    .tab.active { border-color:#d4af37; color:#d4af37; }
    .section { display:none; margin-top:12px; }
    .section.active { display:block; }
    .cards { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:10px; }
    .card,.panel { background:#0c0c0c; border:1px solid #3d3214; border-radius:12px; padding:12px; }
    .tableWrap { overflow:auto; border:1px solid #3d3214; border-radius:12px; margin-top:10px; }
    table { width:100%; border-collapse:collapse; }
    th,td { padding:8px; border-bottom:1px solid #282117; text-align:left; }
    .pill { padding:2px 8px; border:1px solid #5b4a1f; border-radius:999px; font-size:12px; display:inline-block; }
    #customerDetail,#orderDetail { margin-top:10px; }
    .muted { color:#b8b8b8; }
    .err { color:#ff9696; min-height:20px; margin:8px 0; }
    .tags { display:flex; gap:6px; flex-wrap:wrap; }
    .tag { border:1px solid #6b5724; border-radius:999px; padding:4px 8px; }
  </style>
</head>
<body><div class="wrap">
  <h1>Admin Workspace</h1>
  <div class="row">
    <input id="secret" type="password" placeholder="ADMIN_SECRET" />
    <button id="unlockBtn">Unlock</button>
    <button id="refreshBtn">Refresh</button>
    <span id="status" class="muted"></span>
  </div>
  <div id="msg" class="err"></div>

  <div class="row" style="margin-top:10px;">
    <button class="tab active" id="tabDashboard">Dashboard</button>
    <button class="tab" id="tabCustomers">Customers</button>
    <button class="tab" id="tabOrders">Orders</button>
    <button class="tab" id="tabVerification">Verification</button>
  </div>

  <section id="dashboard" class="section active"><div id="metrics" class="cards"></div></section>

  <section id="customers" class="section">
    <div class="row">
      <input id="cQuery" placeholder="search email/name/phone" />
      <select id="cStatus"><option value="all">All status</option><option>pending</option><option>approved</option><option>denied</option></select>
      <select id="cTier"><option value="all">All tier</option><option>member</option><option>insider</option><option>elite</option><option>reserve</option></select>
      <select id="cActive"><option value="">All active</option><option value="1">Active</option><option value="0">Deactivated</option></select>
      <input id="cTag" placeholder="tag" />
      <button id="cSearch">Search</button>
    </div>
    <div class="tableWrap"><table><thead><tr><th>Name</th><th>Email</th><th>Status</th><th>Active</th><th>Tier</th><th>Points</th><th></th></tr></thead><tbody id="cBody"></tbody></table></div>
    <div id="customerDetail" class="panel" style="display:none;"></div>
  </section>

  <section id="orders" class="section">
    <div class="row"><input id="oQuery" placeholder="order id/email/phone/name" /><button id="oSearch">Search</button></div>
    <div class="tableWrap"><table><thead><tr><th>ID</th><th>Date</th><th>Status</th><th>Total</th><th>Type</th><th>Customer</th><th></th></tr></thead><tbody id="oBody"></tbody></table></div>
    <div id="orderDetail" class="panel" style="display:none;"></div>
  </section>

  <section id="verification" class="section"><div id="vList" class="cards"></div></section>
</div>
<script>
const $ = (s)=>document.querySelector(s); const msg=$('#msg'); const statusEl=$('#status');
let currentCustomer=null;
const getSecret=()=>sessionStorage.getItem('bb_admin_secret')||''; const setSecret=v=>sessionStorage.setItem('bb_admin_secret',v);
async function api(path,opts={}){const h=Object.assign({},opts.headers||{}, {'x-admin-secret':getSecret()}); const r=await fetch(path,Object.assign({},opts,{headers:h})); const t=await r.text(); let j={}; try{j=JSON.parse(t)}catch{} if(!r.ok)throw new Error((j.error||t||r.statusText)); return j;}
function showTab(name){['dashboard','customers','orders','verification'].forEach(id=>$('#'+id).classList.toggle('active',id===name)); ['Dashboard','Customers','Orders','Verification'].forEach(n=>$('#tab'+n).classList.toggle('active',n.toLowerCase()===name));}
function fmt(d){if(!d)return '-'; return new Date(d).toLocaleString();}
function cents(v){return '$'+((Number(v||0))/100).toFixed(2)}

async function loadDashboard(){const d=await api('/api/admin/dashboard'); const m=d.metrics||{}; $('#metrics').innerHTML=`<div class=card><h3>Total Users</h3>${m.totalUsers||0}</div><div class=card><h3>Active Users</h3>${m.activeUsers||0}</div><div class=card><h3>Orders (7d)</h3>${m.ordersLast7Days||0}</div><div class=card><h3>Pending Verification</h3>${m.pendingVerification||0}</div>`;}
async function loadCustomers(){const qs=new URLSearchParams({query:$('#cQuery').value||'',status:$('#cStatus').value||'',tier:$('#cTier').value||'',active:$('#cActive').value||'',tag:$('#cTag').value||'',limit:'100'}); const d=await api('/api/admin/customers?'+qs.toString()); const rows=d.customers||[]; statusEl.textContent=`Customers: ${rows.length}`; $('#cBody').innerHTML=''; rows.forEach(u=>{const tr=document.createElement('tr'); tr.innerHTML=`<td>${(u.first_name||'')} ${(u.last_name||'')}</td><td>${u.email||''}</td><td>${u.account_status}</td><td>${Number(u.is_active)===1?'Active':'Deactivated'}</td><td>${u.effectiveTier}</td><td>${u.points_balance||0}</td><td><button>Open</button></td>`; tr.querySelector('button').onclick=()=>openCustomer(u.id); $('#cBody').appendChild(tr);});}
async function openCustomer(id){const d=await api('/api/admin/customers/'+id); currentCustomer=d.customer; const tags=d.tags||[]; const orders=await api('/api/admin/orders?query='+encodeURIComponent(id)); const userOrders=(orders.orders||[]).filter(o=>o.user_id===id);
$('#customerDetail').style.display='block'; $('#customerDetail').innerHTML=`<h3>Customer Detail</h3>
<div class=row><input id=first value="${currentCustomer.first_name||''}" placeholder="first name"><input id=last value="${currentCustomer.last_name||''}" placeholder="last name"><input id=phone value="${currentCustomer.phone||''}" placeholder="phone"><button id=saveProfile>Save Profile</button></div>
<p>Email: <b>${currentCustomer.email}</b> · <span class=pill>${Number(currentCustomer.is_active)===1?'Active':'Deactivated'}</span></p>
<div class=row><button id=approve>Approve</button><button id=deny>Deny</button><button id=pending>Pending</button></div>
<p>Points: ${currentCustomer.points_balance} · Lifetime Spend: ${cents(currentCustomer.lifetime_spend_cents)} · Effective Tier: ${currentCustomer.effectiveTier}</p>
<div class=row><select id=tierOverride><option value=''>Clear override</option><option>member</option><option>insider</option><option>elite</option><option>reserve</option></select><input id=tierReason placeholder='override reason'><button id=saveTier>Save Tier Override</button></div>
<div><h4>Tags</h4><div class=tags>${tags.map(t=>`<span class=tag>${t} <button data-tag="${t}" class=delTag>x</button></span>`).join('')}</div><div class=row><input id=newTag placeholder='add tag'><button id=addTag>Add Tag</button></div></div>
<div><h4>Orders</h4>${userOrders.length?'<pre style="white-space:pre-wrap">'+JSON.stringify(userOrders,null,2)+'</pre>':'<div class=muted>No user orders</div>'}</div>
<div><h4>Actions</h4><div class=row><button id=deactivate>Deactivate</button><button id=reactivate>Reactivate</button></div>
<div style='margin-top:8px;border:1px solid #5b1f1f;padding:8px;border-radius:8px;'><b>Danger Zone</b><div class=row><input id=confirmEmail placeholder='confirm email'><label><input id=anonymize type=checkbox> anonymize orders</label><button id=hardDelete>Hard Delete</button></div></div></div>`;
$('#tierOverride').value=currentCustomer.tier_override||'';
$('#saveProfile').onclick=()=>api('/api/admin/customers/'+id,{method:'PUT',headers:{'content-type':'application/json'},body:JSON.stringify({first_name:$('#first').value,last_name:$('#last').value,phone:$('#phone').value})}).then(()=>openCustomer(id));
$('#approve').onclick=()=>api('/api/admin/customers/'+id+'/status',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({account_status:'approved'})}).then(()=>openCustomer(id));
$('#deny').onclick=()=>api('/api/admin/customers/'+id+'/status',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({account_status:'denied',status_reason:prompt('Reason')||''})}).then(()=>openCustomer(id));
$('#pending').onclick=()=>api('/api/admin/customers/'+id+'/status',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({account_status:'pending'})}).then(()=>openCustomer(id));
$('#saveTier').onclick=()=>api('/api/admin/customers/'+id+'/tier',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({tier_override:$('#tierOverride').value||null,reason:$('#tierReason').value||''})}).then(()=>openCustomer(id));
$('#addTag').onclick=()=>api('/api/admin/customers/'+id+'/tags',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({tag:$('#newTag').value})}).then(()=>openCustomer(id));
document.querySelectorAll('.delTag').forEach(b=>b.onclick=()=>api('/api/admin/customers/'+id+'/tags/'+encodeURIComponent(b.dataset.tag),{method:'DELETE'}).then(()=>openCustomer(id)));
$('#deactivate').onclick=()=>api('/api/admin/customers/'+id+'/deactivate',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({reason:prompt('Reason optional')||''})}).then(()=>openCustomer(id));
$('#reactivate').onclick=()=>api('/api/admin/customers/'+id+'/reactivate',{method:'POST'}).then(()=>openCustomer(id));
$('#hardDelete').onclick=()=>api('/api/admin/customers/'+id,{method:'DELETE',headers:{'content-type':'application/json'},body:JSON.stringify({confirmEmail:$('#confirmEmail').value,anonymizeOrders:$('#anonymize').checked})}).then(()=>{$('#customerDetail').style.display='none';loadCustomers();});
}
async function loadOrders(){const d=await api('/api/admin/orders?query='+encodeURIComponent($('#oQuery').value||'')); const rows=d.orders||[]; $('#oBody').innerHTML=''; rows.forEach(o=>{const tr=document.createElement('tr'); tr.innerHTML=`<td>${o.id}</td><td>${fmt(o.created_at)}</td><td>${o.status}</td><td>${cents(o.total_cents)}</td><td>${o.user_id?'Account':'Guest'}</td><td>${o.customer_name||o.customer_email||'-'}</td><td><button>Open</button></td>`; tr.querySelector('button').onclick=()=>openOrder(o.id); $('#oBody').appendChild(tr);});}
async function openOrder(id){const d=await api('/api/admin/orders/'+id); $('#orderDetail').style.display='block'; $('#orderDetail').innerHTML='<h3>Order '+id+'</h3><pre style="white-space:pre-wrap">'+JSON.stringify(d.order,null,2)+'</pre>';}
async function loadVerification(){const d=await api('/api/admin/verification/pending'); const users=d.users||[]; $('#vList').innerHTML=users.length?users.map(u=>`<div class=card><h3>${u.first_name||''} ${u.last_name||''}</h3><div>${u.email||''}</div><button onclick="openCustomer('${u.id.replace(/'/g,"\\'")}');showTab('customers')">Review</button></div>`).join(''):'<div class=muted>No pending users.</div>';}

$('#unlockBtn').onclick=async()=>{try{setSecret($('#secret').value.trim()); msg.textContent=''; await refresh();}catch(e){msg.textContent=e.message}};
$('#refreshBtn').onclick=()=>refresh().catch(e=>msg.textContent=e.message);
$('#cSearch').onclick=()=>loadCustomers().catch(e=>msg.textContent=e.message); $('#oSearch').onclick=()=>loadOrders().catch(e=>msg.textContent=e.message);
$('#tabDashboard').onclick=()=>{showTab('dashboard');loadDashboard().catch(e=>msg.textContent=e.message)};
$('#tabCustomers').onclick=()=>{showTab('customers');loadCustomers().catch(e=>msg.textContent=e.message)};
$('#tabOrders').onclick=()=>{showTab('orders');loadOrders().catch(e=>msg.textContent=e.message)};
$('#tabVerification').onclick=()=>{showTab('verification');loadVerification().catch(e=>msg.textContent=e.message)};
async function refresh(){if(!getSecret()) throw new Error('Enter ADMIN_SECRET and unlock.'); const active=document.querySelector('.section.active').id; if(active==='dashboard') await loadDashboard(); if(active==='customers') await loadCustomers(); if(active==='orders') await loadOrders(); if(active==='verification') await loadVerification();}
window.addEventListener('DOMContentLoaded',()=>{const s=getSecret(); if(s){$('#secret').value=s; refresh().catch(()=>{});}});
</script>
</body></html>
