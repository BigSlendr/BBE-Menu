export function json(data: unknown, status = 200) {
  return new Response(JSON.stringify(data), {
    status,
    headers: {
      "content-type": "application/json; charset=utf-8",
      "cache-control": "no-store",
    },
  });
}

function getCookie(request: Request, name: string) {
  const cookie = request.headers.get("cookie") || "";
  const parts = cookie.split(";").map((p) => p.trim());
  for (const p of parts) {
    if (p.startsWith(name + "=")) return p.substring(name.length + 1);
  }
  return null;
}

export async function getSessionUserId(request: Request, env: any): Promise<string | null> {
  const sessionId = getCookie(request, "bb_session");
  if (!sessionId) return null;

  const db = env.DB as D1Database;
  const session = await db
    .prepare("SELECT user_id, expires_at FROM sessions WHERE id = ?")
    .bind(sessionId)
    .first<any>();

  if (!session) return null;
  if (Date.parse(session.expires_at) < Date.now()) return null;

  return session.user_id || null;
}

export async function getVerificationStatus(userId: string, env: any): Promise<string> {
  const db = env.DB as D1Database;
  const row = await db
    .prepare("SELECT account_status FROM users WHERE id = ?")
    .bind(userId)
    .first<{ account_status?: string }>();

  return row?.account_status || "pending";
}

export function requireAdmin(request: Request, env: any): boolean {
  if (!env.ADMIN_SECRET) return false;
  const secret = request.headers.get("x-admin-secret") || getCookie(request, "bb_admin_secret");
  return Boolean(secret && secret === env.ADMIN_SECRET);
}
