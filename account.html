<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bobby Black — Account</title>
  <style>
    body { margin:0; background:#000; color:#fff; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
    .bb-header{width:100%;background:#000;border-bottom:1px solid rgba(255,255,255,.16);position:sticky;top:0;z-index:1000}
    .bb-header-row1{display:flex;align-items:center;justify-content:center;position:relative;padding:10px 14px}
    .bb-logo img{height:42px;display:block}
    .bb-cart-btn{position:absolute;right:14px;top:50%;transform:translateY(-50%);display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:999px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.18);color:#fff;text-decoration:none;font-size:12px;font-weight:700;letter-spacing:.04em;text-transform:uppercase}
    .bb-cart-count{display:none;background:#fff;color:#111;border-radius:999px;padding:2px 7px;font-size:11px;font-weight:900;min-width:20px;text-align:center}
    .bb-nav{display:flex;gap:18px;justify-content:center;align-items:center;padding:8px 12px 10px;border-top:1px solid rgba(255,255,255,.10)}
    .bb-nav a{color:#fff;text-decoration:none;font-size:13px;letter-spacing:.08em;text-transform:uppercase;opacity:.9}
    .bb-nav a:hover{opacity:1;text-decoration:underline}

    .container{max-width:980px;margin:22px auto 44px;padding:0 16px}
    .title{font-size:30px;letter-spacing:.03em;margin:0 0 6px}
    .muted{color:#b7b7b7}
    .gold{color:#c5a46d}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:12px;margin-top:14px}
    .card{background:#0a0a0a;border:1px solid #252525;border-radius:14px;padding:14px}
    .card h2{font-size:14px;letter-spacing:.1em;text-transform:uppercase;color:#c5a46d;margin:0 0 10px}
    .value{font-size:28px;font-weight:800}
    .badge{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:700;font-size:12px;letter-spacing:.05em;text-transform:uppercase}
    .status-approved{background:rgba(50,155,99,.18);border:1px solid #329b63;color:#9ff2bf}
    .status-pending{background:rgba(197,164,109,.15);border:1px solid #c5a46d;color:#f4d49b}
    .status-denied{background:rgba(155,63,63,.2);border:1px solid #b55656;color:#ffb6b6}
    .orders{margin-top:12px}
    table{width:100%;border-collapse:collapse;background:#090909;border:1px solid #252525;border-radius:12px;overflow:hidden}
    th,td{padding:10px;border-bottom:1px solid #1d1d1d;text-align:left;font-size:14px}
    th{font-size:12px;color:#c5a46d;text-transform:uppercase;letter-spacing:.08em}
    tr:last-child td{border-bottom:none}
    #logoutBtn{margin-top:10px;background:#151515;border:1px solid #323232;color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
  </style>
</head>
<body>
<header class="bb-header">
  <div class="bb-header-row1">
    <a href="index.html" class="bb-logo" aria-label="Bobby Black Home">
      <img src="images/Bobbyblack.png" alt="Bobby Black" />
    </a>
    <a href="cart.html" class="bb-cart-btn" aria-label="Open cart">
      <span>Cart</span>
      <span id="bbCartCount" class="bb-cart-count">0</span>
    </a>
  </div>
  <nav class="bb-nav">
    <a href="categories.html">Shop</a>
    <a href="about.html">About</a>
    <a href="member-signin.html" id="bbMemberLink">Sign In</a>
  </nav>
</header>

<main class="container">
  <h1 class="title">My Account</h1>
  <p id="emailLine" class="muted">Loading account…</p>
  <button id="logoutBtn" type="button">Log out</button>

  <section class="grid">
    <article class="card">
      <h2>Verification</h2>
      <p><span id="statusBadge" class="badge status-pending">Pending Verification</span></p>
      <p id="verifiedAt" class="muted" style="margin-top:10px;"></p>
      <p id="statusReason" class="muted" style="margin-top:6px;"></p>
    </article>

    <article class="card">
      <h2>Rewards</h2>
      <div class="muted">Points Balance</div>
      <div class="value" id="pointsBalance">0</div>
      <div class="muted" style="margin-top:10px;">Tier: <span id="tier" class="gold">member</span></div>
      <div class="muted">Lifetime Spend: <span id="lifetimeSpend">$0.00</span></div>
    </article>
  </section>

  <section class="orders">
    <div class="card">
      <h2>Order History</h2>
      <div id="ordersWrap" class="muted">Loading orders…</div>
    </div>
  </section>
</main>

<script defer src="/auth.js?v=7"></script>
<script defer src="/header-auth.js?v=7"></script>
<script>
  const asMoney = (cents) => `$${(Number(cents || 0) / 100).toFixed(2)}`;

  function formatDate(iso) {
    const d = new Date(iso || "");
    if (Number.isNaN(d.getTime())) return "—";
    return d.toLocaleString();
  }

  function renderStatus(user) {
    const badge = document.getElementById("statusBadge");
    const verifiedAt = document.getElementById("verifiedAt");
    const statusReason = document.getElementById("statusReason");

    const status = String(user.account_status || "pending").toLowerCase();
    badge.className = "badge";

    if (status === "approved") {
      badge.textContent = "Verified";
      badge.classList.add("status-approved");
    } else if (status === "denied") {
      badge.textContent = "Not Approved";
      badge.classList.add("status-denied");
    } else {
      badge.textContent = "Pending Verification";
      badge.classList.add("status-pending");
    }

    verifiedAt.textContent = user.verified_at ? `Verified at: ${formatDate(user.verified_at)}` : "";
    statusReason.textContent = status === "denied" && user.status_reason ? `Reason: ${user.status_reason}` : "";
  }

  function renderOrders(orders) {
    const wrap = document.getElementById("ordersWrap");
    if (!Array.isArray(orders) || orders.length === 0) {
      wrap.textContent = "No orders yet.";
      return;
    }

    wrap.innerHTML = `
      <table>
        <thead>
          <tr>
            <th>Date</th><th>Status</th><th>Total</th><th>Points Earned</th><th>Redeemed</th>
          </tr>
        </thead>
        <tbody>
          ${orders.map((o) => `
            <tr>
              <td>${formatDate(o.created_at)}</td>
              <td>${o.status || "placed"}</td>
              <td>${asMoney(o.total_cents)}</td>
              <td>${Number(o.points_earned || 0)}</td>
              <td>${Number(o.points_redeemed || 0)}</td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    `;
  }

  async function loadAccount() {
    const meRes = await fetch("/api/me");
    if (meRes.status === 401) {
      window.location.href = "/member-signin.html";
      return;
    }
    const mePayload = await meRes.json();
    const user = mePayload?.user;
    if (!meRes.ok || !user) throw new Error("Failed to load account");

    document.getElementById("emailLine").textContent = user.email || "Signed in";
    document.getElementById("pointsBalance").textContent = String(Number(user.points_balance || 0));
    document.getElementById("tier").textContent = String(user.tier || "member");
    document.getElementById("lifetimeSpend").textContent = asMoney(user.lifetime_spend_cents || 0);
    renderStatus(user);

    const ordersRes = await fetch("/api/orders/me");
    if (ordersRes.status === 401) {
      window.location.href = "/member-signin.html";
      return;
    }
    const ordersPayload = await ordersRes.json();
    renderOrders(ordersPayload?.orders || []);
  }

  document.getElementById("logoutBtn").addEventListener("click", async () => {
    await fetch("/api/auth/logout", { method: "POST" }).catch(() => {});
    window.location.href = "/index.html";
  });

  loadAccount().catch(() => {
    document.getElementById("emailLine").textContent = "Unable to load account.";
    document.getElementById("ordersWrap").textContent = "Unable to load orders.";
  });
</script>
</body>
</html>
